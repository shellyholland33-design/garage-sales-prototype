<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garage Sales – Toowoomba Prototype</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<style>
  :root { --bg:#f7f7f8; --card:#ffffff; --ink:#111827; --muted:#6b7280; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{background:#fff;border-bottom:1px solid #e5e7eb}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:20px}
  nav button{padding:8px 14px;border:0;border-radius:999px;background:#e5e7eb;cursor:pointer}
  nav button.active{background:#111827;color:#fff}
  .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-top:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input[type="text"],input[type="date"],input[type="time"]{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .chip{background:#e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .btn{padding:10px 12px;border-radius:12px;border:0;cursor:pointer;font-size:14px}
  .btn.primary{background:#111827;color:#fff}
  .btn.alt{background:#e5e7eb}
  .btn.link{background:transparent;text-decoration:underline}
  .muted{color:var(--muted);font-size:14px}
  .list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:900px){.list{grid-template-columns:1fr}}
  .tags span{background:#f3f4f6;border-radius:999px;padding:4px 8px;font-size:12px;margin-right:6px}
  .pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px}
  .warn{color:#b91c1c;font-size:12px}
  #map{height:520px;border-radius:16px;overflow:hidden}
  .legend{display:flex;gap:10px;align-items:center;margin-top:8px}
  .dot{width:10px;height:10px;border-radius:50%}
  .status{display:flex;align-items:center;gap:6px}
  .dim{opacity:.45}
  footer{color:var(--muted);text-align:center;padding:24px}
  .sources{display:flex;gap:10px;flex-wrap:wrap}
  .sources label{display:flex;align-items:center;gap:6px;font-size:13px}
  /* tiny inline error banner for quick debugging */
  #err{display:none;position:fixed;left:10px;right:10px;bottom:10px;background:#fee2e2;color:#7f1d1d;padding:10px;border-radius:8px;font-size:13px;z-index:9999}
</style>
</head>
<body>
<header>
  <div class="wrap row" style="align-items:center;justify-content:space-between">
    <h1>Garage Sales</h1>
    <nav class="row">
      <button id="tab-search" class="active">Search</button>
      <button id="tab-map">Map</button>
      <button id="tab-planner">Planner</button>
      <button id="tab-favs">Favourites</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Filters -->
  <section class="card" id="filters">
    <div class="grid">
      <div>
        <label>Date</label>
        <input type="date" id="f-date" />
      </div>
      <div>
        <label>Town, city or postcode</label>
        <input type="text" id="f-location" placeholder="Toowoomba or 4350" value="Toowoomba" />
      </div>
      <div>
        <label>Item</label>
        <input type="text" id="f-item" placeholder="bike, pram, tools" />
      </div>
      <div class="row" style="align-items:flex-end">
        <span class="chip" data-quick="bike">bike</span>
        <span class="chip" data-quick="tools">tools</span>
        <span class="chip" data-quick="furniture">furniture</span>
        <span class="chip" data-quick="baby">baby</span>
        <span class="chip" data-quick="retro">retro</span>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Sources</label>
      <div class="sources">
        <label><input type="checkbox" class="src" value="craigslist" checked/> Craigslist</label>
        <label><input type="checkbox" class="src" value="newspaper" checked/> Newspapers</label>
        <label><input type="checkbox" class="src" value="noticeboard" checked/> Community noticeboards</label>
        <label><input type="checkbox" class="src" value="facebook" checked/> Facebook</label>
        <label><input type="checkbox" class="src" value="gumtree" checked/> Gumtree</label>
        <label><input type="checkbox" class="src" value="marketplace" checked/> Marketplace</label>
      </div>
    </div>
  </section>

  <!-- Search -->
  <section id="search-view">
    <div id="results" class="list"></div>
  </section>

  <!-- Map -->
  <section id="map-view" style="display:none">
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:8px">
        <div class="row" style="gap:12px">
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="toggle-all" checked /> Show all (on date)
          </label>
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="toggle-chosen" checked /> Show today's chosen
          </label>
        </div>
        <div class="legend">
          <span class="dot" style="background:#2563eb"></span><span class="muted">normal</span>
          <span class="dot" style="background:#10b981"></span><span class="muted">chosen</span>
          <span class="dot" style="background:#f59e0b"></span><span class="muted">viewed</span>
          <span class="dot" style="background:#ef4444"></span><span class="muted">dismissed</span>
        </div>
      </div>
      <div id="map"></div>
      <div class="muted" style="margin-top:8px">Click a pin for quick actions (Choose / View / Dismiss).</div>
    </div>
  </section>

  <!-- Planner -->
  <section id="planner-view" style="display:none">
    <div class="card">
      <div class="row" style="gap:12px">
        <div style="flex:1;min-width:180px">
          <label>Start time</label>
          <input type="time" id="p-start" value="08:30" />
        </div>
        <div style="flex:2;min-width:260px">
          <label>Start location</label>
          <input type="text" id="p-origin" value="Queens Park, Toowoomba QLD" />
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Order is based on nearest neighbour with time windows; drive times are estimated.</div>
      <div id="route" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- Favourites -->
  <section id="favs-view" style="display:none">
    <div id="favs-list" class="list"></div>
  </section>
</main>

<footer>Prototype only. Demo data. Live feeds come later.</footer>
<div id="err"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script>
/* ===== tiny error banner so a bad paste never leaves a blank page ===== */
window.addEventListener('error', (e)=>{
  const box = document.getElementById('err');
  box.style.display='block';
  box.textContent = 'Error: ' + (e.message || e.error);
});

/* ====================== helpers ====================== */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

function localISODate(date = new Date()) {
  const tz = date.getTimezoneOffset() * 60000; // minutes -> ms
  return new Date(date.getTime() - tz).toISOString().slice(0, 10);
}
const todayISO = localISODate(); // device-local today (AEST ok)

function toISODate(value){
  if(!value) return todayISO;
  if(value.includes('/')){
    const [dd,mm,yyyy]=value.split('/');
    if(dd&&mm&&yyyy) return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
  }
  return value;
}
const minutes=(hhmm)=>{const [h,m]=hhmm.split(':').map(n=>parseInt(n,10));return h*60+m;}
const hhmm=(m)=>`${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const formatDate=(iso)=>new Date(iso+"T00:00:00").toLocaleDateString(undefined,{weekday:"short",day:"numeric",month:"short"});
const share=(text,url)=>{if(navigator.share){navigator.share({title:"Garage Sales",text,url}).catch(()=>{})}else{navigator.clipboard?.writeText(text+" "+url);alert("Link copied.");}};

/* ====================== sample Toowoomba data (10 listings over 30–31 Aug) ====================== */
const D0 = "2025-08-30";
const D1 = "2025-08-31";
const T=(h,m)=>`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

const SALES = [
  {id:"T1",title:"Rangeville family clear-out (bikes, books)",source:"newspaper",addr:"12 South Street, Rangeville QLD 4350",lat:-27.58,lng:151.973,tags:["bike","books","pram","tools"],open:[{date:D0,start:T(8,0),end:T(12,0)},{date:D1,start:T(8,0),end:T(12,0)}]},
  {id:"T2",title:"Centenary Heights downsizing – furniture & tools",source:"craigslist",addr:"5 Southland Street, Centenary Heights QLD 4350",lat:-27.594,lng:151.966,tags:["furniture","tools"],open:[{date:D0,start:T(9,0),end:T(13,0)},{date:D1,start:T(9,0),end:T(13,0)}]},
  {id:"T3",title:"Newtown shed sale – retro, records",source:"noticeboard",addr:"40 Holberton Street, Newtown QLD 4350",lat:-27.558,lng:151.93,tags:["retro","records"],open:[{date:D0,start:T(8,30),end:T(12,30)}]},
  {id:"T4",title:"Harristown moving sale – baby gear",source:"facebook",addr:"18 Campbell Street, Harristown QLD 4350",lat:-27.586,lng:151.929,tags:["baby","clothes","cot"],open:[{date:D1,start:T(10,0),end:T(14,0)}]},
  {id:"T5",title:"Kearneys Spring multi-house sale – camping",source:"gumtree",addr:"6 West Street, Kearneys Spring QLD 4350",lat:-27.603,lng:151.945,tags:["camping","tools"],open:[{date:D0,start:T(7,30),end:T(11,30)}]},
  {id:"T6",title:"East Toowoomba – garden & kitchenware",source:"newspaper",addr:"98 Mary Street, East Toowoomba QLD 4350",lat:-27.563,lng:151.971,tags:["garden","kitchen"],open:[{date:D1,start:T(8,0),end:T(12,0)}]},
  {id:"T7",title:"North Toowoomba – bikes & games",source:"marketplace",addr:"15 Jones Street, North Toowoomba QLD 4350",lat:-27.541,lng:151.946,tags:["bike","games"],open:[{date:D1,start:T(9,30),end:T(12,30)}]},
  {id:"T8",title:"Wilsonton – tools, mower, ladders",source:"craigslist",addr:"2 Erin Street, Wilsonton QLD 4350",lat:-27.54,lng:151.903,tags:["tools","lawn"],open:[{date:D0,start:T(8,0),end:T(12,0)}]},
  {id:"T9",title:"Mount Lofty – retro lamps & decor",source:"noticeboard",addr:"7 Stuart Street, Mount Lofty QLD 4350",lat:-27.545,lng:151.963,tags:["retro","decor"],open:[{date:D1,start:T(10,0),end:T(14,0)}]},
  {id:"T10",title:"South Toowoomba – pram, kids clothes",source:"newspaper",addr:"21 Long Street, South Toowoomba QLD 4350",lat:-27.575,lng:151.948,tags:["pram","clothes"],open:[{date:D0,start:T(8,30),end:T(12,30)}]}
];

/* ====================== state ====================== */
const state={
  date: todayISO,
  location:"Toowoomba",
  item:"",
  sources: new Set(["craigslist","newspaper","noticeboard","facebook","gumtree","marketplace"]),
  view:"search",
  favourites: JSON.parse(localStorage.getItem("favs")||"[]"),
  selected:   JSON.parse(localStorage.getItem("sel")||"[]"),
  viewed:     JSON.parse(localStorage.getItem("viewed")||"[]"),
  dismissed:  JSON.parse(localStorage.getItem("dismissed")||"[]")
};
function saveState(){
  localStorage.setItem("favs", JSON.stringify(state.favourites));
  localStorage.setItem("sel", JSON.stringify(state.selected));
  localStorage.setItem("viewed", JSON.stringify(state.viewed));
  localStorage.setItem("dismissed", JSON.stringify(state.dismissed));
}

/* ====================== inputs ====================== */
$("#f-date").value = state.date;
$("#f-date").addEventListener("change",e=>{ state.date=toISODate(e.target.value); render(); });
$("#f-location").addEventListener("input",e=>{ state.location=e.target.value; render(); });
$("#f-item").addEventListener("input",e=>{ state.item=e.target.value; render(); });
$$(".chip").forEach(ch=>ch.addEventListener("click",()=>{ state.item=ch.dataset.quick; $("#f-item").value=state.item; render(); }));
$$(".src").forEach(cb=>cb.addEventListener("change",()=>{ cb.checked?state.sources.add(cb.value):state.sources.delete(cb.value); render(); }));

/* ====================== status helpers ====================== */
function markViewed(id){ if(!state.viewed.includes(id)){ state.viewed.push(id); saveState(); render(); } }
function toggleChosen(id){ const i=state.selected.indexOf(id); if(i>=0) state.selected.splice(i,1); else state.selected.push(id); saveState(); render(); }
function toggleDismiss(id){ const i=state.dismissed.indexOf(id); if(i>=0) state.dismissed.splice(i,1); else state.dismissed.push(id); saveState(); render(); }
function statusOf(id){ if(state.dismissed.includes(id)) return "dismissed"; if(state.selected.includes(id)) return "chosen"; if(state.viewed.includes(id)) return "viewed"; return "normal"; }

/* ====================== filtering ====================== */
function synonyms(term){
  const t=(term||"").toLowerCase();
  const map={bike:["bicycle","push bike","mtb","road bike","kids bike"],pram:["stroller","buggy"],sofa:["couch","lounge"],cot:["travel cot","portacot"]};
  return map[t]||[];
}
function onDateSales(){
  const d = state.date;
  return SALES.filter(s=>s.open.some(w=>w.date===d));
}
function filteredForList(){
  const loc=(state.location||"").toLowerCase().trim();
  const term=(state.item||"").toLowerCase().trim();
  const syns=synonyms(term);
  return onDateSales().filter(s=>{
    if(!state.sources.has(s.source)) return false;
    const hay=(s.addr).toLowerCase();
    const text=(s.title+" "+(s.tags||[]).join(" ")).toLowerCase();
    const matchesLoc = loc==="" || hay.includes(loc);
    const matchesItem = term==="" || text.includes(term) || syns.some(x=>text.includes(x));
    return matchesLoc && matchesItem;
  });
}

/* ====================== list ====================== */
function saleCard(s){
  const st=statusOf(s.id);
  const isFav=state.favourites.includes(s.id);
  const mapsURL="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(s.addr);
  const el=document.createElement("div"); el.className="card"+(st==="dismissed"?" dim":"");
  const w=s.open.find(x=>x.date===state.date) || s.open[0];
  const dotColor = {normal:"#2563eb",chosen:"#10b981",viewed:"#f59e0b",dismissed:"#ef4444"}[st];
  el.innerHTML=`
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="status"><span class="dot" style="background:${dotColor}"></span>
          <strong>${s.title}</strong>
        </div>
        <div class="muted">${s.addr}</div>
        <div class="muted" style="margin-top:4px">Source: ${s.source}</div>
        <div class="tags" style="margin-top:6px">${(s.tags||[]).map(t=>`<span>${t}</span>`).join("")}</div>
        <div class="row" style="margin-top:6px">
          <span class="pill">${formatDate(state.date)}</span>
          <span class="pill">Open ${w.start}–${w.end}</span>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <a class="btn primary" href="${mapsURL}" target="_blank" rel="noreferrer" data-view>Open in Maps</a>
      <button class="btn alt" data-invite>Invite friends</button>
      <button class="btn alt" data-fav>${isFav?"Saved":"Save"}</button>
      <button class="btn alt" data-sel>${st==="chosen"?"Selected":"Add to route"}</button>
      <button class="btn link" data-dismiss>${st==="dismissed"?"Undismiss":"Dismiss"}</button>
    </div>
  `;
  el.querySelector("[data-view]").addEventListener("click",()=>markViewed(s.id));
  el.querySelector("[data-invite]").addEventListener("click",()=>share(`Garage sale: ${s.title} at ${s.addr}`, `https://garagesales.app/sale/${s.id}`));
  el.querySelector("[data-fav]").addEventListener("click",()=>{
    const i=state.favourites.indexOf(s.id); if(i>=0) state.favourites.splice(i,1); else state.favourites.push(s.id);
    saveState(); render();
  });
  el.querySelector("[data-sel]").addEventListener("click",()=>toggleChosen(s.id));
  el.querySelector("[data-dismiss]").addEventListener("click",()=>toggleDismiss(s.id));
  return el;
}
function renderSearch(){
  const list=$("#results"); list.innerHTML="";
  const items=filteredForList();
  if(items.length===0){ const empty=document.createElement("div"); empty.className="card"; empty.innerHTML=`<div class="muted">No results for your filters.</div>`; list.appendChild(empty); return; }
  items.forEach(s=>list.appendChild(saleCard(s)));
}

/* ====================== favourites ====================== */
function renderFavs(){
  const list=$("#favs-list"); list.innerHTML="";
  const favs = filteredForList().filter(s=>state.favourites.includes(s.id));
  if(favs.length===0){ const empty=document.createElement("div"); empty.className="card"; empty.innerHTML=`<div class="muted">No favourites yet. Save a sale first.</div>`; list.appendChild(empty); return; }
  favs.forEach(s=>list.appendChild(saleCard(s)));
}

/* ====================== planner ====================== */
function kmBetween(a,b){
  const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180, la2=b.lat*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}
function buildRoute(dateISO,startHHMM,selectedSales){
  if(!selectedSales.length) return [];
  const speed=40; let now=minutes(startHHMM);
  let current={lat:selectedSales[0].lat,lng:selectedSales[0].lng};
  const remaining=selectedSales.map(s=>{const w=s.open.find(w=>w.date===dateISO)||s.open[0];return {...s,windowStart:w.start,windowEnd:w.end,start:minutes(w.start),end:minutes(w.end)};});
  const ordered=[];
  while(remaining.length){
    remaining.sort((a,b)=>kmBetween(current,a)-kmBetween(current,b));
    const next=remaining.shift(), dist=kmBetween(current,next), drive=Math.ceil((dist/speed)*60);
    let eta=now+drive; if(eta<next.start) eta=next.start;
    const conflict=eta>next.end;
    ordered.push({...next, etaHH:hhmm(eta), conflict});
    now=Math.min(Math.max(eta,next.start),next.end);
    current={lat:next.lat,lng:next.lng};
  }
  return ordered;
}
function renderPlanner(){
  const wrap=$("#route"); wrap.innerHTML="";
  const selected=onDateSales().filter(s=>state.selected.includes(s.id));
  if(!selected.length){ wrap.innerHTML=`<div class="muted">No selected sales for this day. Choose a few from Search or Favourites.</div>`; return; }
  const order=buildRoute(state.date,$("#p-start").value,selected);
  order.forEach((s,idx)=>{
    const dir="https://www.google.com/maps/dir/?api=1&destination="+encodeURIComponent(s.addr);
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div><strong>${idx+1}. ${s.title}</strong></div>
        ${s.conflict?`<div class="warn">Outside open time</div>`:""}
      </div>
      <div class="muted">${s.addr}</div>
      <div class="row" style="margin-top:6px">
        <span class="pill">ETA ${s.etaHH}</span>
        <span class="pill">${formatDate(state.date)}</span>
        <span class="pill">Open ${s.windowStart}–${s.windowEnd}</span>
      </div>
      <div class="row" style="margin-top:10px">
        <a class="btn primary" href="${dir}" target="_blank" rel="noreferrer">Directions</a>
      </div>`;
    wrap.appendChild(card);
  });
}
$("#p-start").addEventListener("change",renderPlanner);

/* ====================== map ====================== */
function pin(color){return L.icon({iconUrl:`data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='28' height='40'><path d='M14 0C6.82 0 1 5.82 1 13c0 9.5 13 27 13 27s13-17.5 13-27C27 5.82 21.18 0 14 0z' fill='${color}'/><circle cx='14' cy='13' r='5' fill='white'/></svg>`)}`,iconSize:[28,40],iconAnchor:[14,40],popupAnchor:[0,-36]});}
const ICONS={normal:pin("#2563eb"),chosen:pin("#10b981"),viewed:pin("#f59e0b"),dismissed:pin("#ef4444")};
let map,allLayer,chosenLayer,mapReady=false;

function ensureMap(){
  if(mapReady){ updateMap(); return; }
  map=L.map('map',{zoomControl:true}).setView([-27.5598,151.9507],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
  allLayer=L.layerGroup().addTo(map);
  chosenLayer=L.layerGroup().addTo(map);
  $("#toggle-all").addEventListener("change",updateMap);
  $("#toggle-chosen").addEventListener("change",updateMap);
  mapReady=true; updateMap();
}
function addPopupActions(s,m){
  m.bindPopup(`
    <strong>${s.title}</strong><br/>
    <span class="muted">${s.addr}</span><br/>
    <span class="muted">Source: ${s.source}</span><br/>
    <button id="pp-choose-${s.id}" class="btn alt" style="margin-top:6px">Choose</button>
    <button id="pp-view-${s.id}" class="btn alt" style="margin-top:6px">View</button>
    <button id="pp-dismiss-${s.id}" class="btn alt" style="margin-top:6px">${state.dismissed.includes(s.id)?"Undismiss":"Dismiss"}</button>
  `);
  m.on('popupopen',()=>{
    $("#pp-choose-"+s.id).onclick = ()=>{ toggleChosen(s.id); updateMap(); };
    $("#pp-view-"+s.id).onclick   = ()=>{ markViewed(s.id); updateMap(); };
    $("#pp-dismiss-"+s.id).onclick= ()=>{ toggleDismiss(s.id); updateMap(); };
  });
}
function updateMap(){
  allLayer.clearLayers(); chosenLayer.clearLayers();
  const allOnDate = filteredForList(); // apply filters
  const pts=[];
  const add=(layer,s,icon)=>{ const m=L.marker([s.lat,s.lng],{icon:ICONS[icon]}); addPopupActions(s,m); m.addTo(layer); pts.push([s.lat,s.lng]); };
  if($("#toggle-all").checked) allOnDate.forEach(s=> add(allLayer,s,statusOf(s.id)));
  if($("#toggle-chosen").checked) allOnDate.filter(s=>state.selected.includes(s.id)).forEach(s=> add(chosenLayer,s,"chosen"));
  if(pts.length) try{ map.fitBounds(pts,{padding:[30,30]}); } catch{}
}

/* ====================== tabs & render ====================== */
function setTab(tab){
  state.view=tab;
  $("#tab-search").classList.toggle("active",tab==="search");
  $("#tab-map").classList.toggle("active",tab==="map");
  $("#tab-planner").classList.toggle("active",tab==="planner");
  $("#tab-favs").classList.toggle("active",tab==="favs");
  $("#search-view").style.display  = tab==="search"  ? "" : "none";
  $("#map-view").style.display     = tab==="map"     ? "" : "none";
  $("#planner-view").style.display = tab==="planner" ? "" : "none";
  $("#favs-view").style.display    = tab==="favs"    ? "" : "none";
  render();
  if(tab==="map") ensureMap();
}
$("#tab-search").addEventListener("click",()=>setTab("search"));
$("#tab-map").addEventListener("click",()=>setTab("map"));
$("#tab-planner").addEventListener("click",()=>setTab("planner"));
$("#tab-favs").addEventListener("click",()=>setTab("favs"));

function render(){
  if(state.view==="search")  renderSearch();
  if(state.view==="favs")    renderFavs();
  if(state.view==="planner") renderPlanner();
  if(state.view==="map" && mapReady) updateMap();
}
renderSearch(); // first paint
</script>
</body>
</html>
